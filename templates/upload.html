{% extends 'base.html' %}

{% block title %}上传新播客{% endblock %}

{% block content %}
    <div class="upload-form">
        <h2>发布新播客</h2>
        
        {% if use_cloudinary %}
        <!-- Cloudinary上传模式 -->
        <form id="podcast-form" method="post">
            <div class="form-group">
                <label for="title">标题:</label>
                <input type="text" id="title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="description">描述:</label>
                <textarea id="description" name="description" rows="5" required></textarea>
                <small>支持基本HTML标签</small>
            </div>
            
            <div class="form-group">
                <label for="audio_file">音频文件 (MP3):</label>
                <button type="button" id="upload_widget" class="rainbow-button">选择音频文件</button>
                <div id="upload-status"></div>
                <input type="hidden" id="audio_url" name="audio_url">
                <input type="hidden" id="audio_filename" name="audio_filename">
            </div>
            
            <div class="form-group">
                <label for="password">密码保护 (可选):</label>
                <input type="password" id="password" name="password">
                <small>如果设置密码，此集将不会出现在RSS Feed中</small>
            </div>
            
            <button type="submit" class="rainbow-button" id="submit-button" disabled>上传播客</button>
        </form>
        
        <!-- Cloudinary上传脚本 -->
        <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
        <script>
            const myWidget = cloudinary.createUploadWidget({
                cloudName: 'ml_default',
                uploadPreset: 'ml_default',
                resourceType: "auto",
                sources: ["local"],
                multiple: false,
                maxFileSize: 100000000,
                folder: "podcasts",
                allowedFormats: ["mp3", "mpeg"]
            }, (error, result) => {
                if (error) {
                    document.getElementById("upload-status").textContent = "上传出错: " + error.message;
                    return;
                }
                
                if (result.event === "success") {
                    const fileUrl = result.info.secure_url;
                    const fileName = result.info.original_filename;
                    
                    document.getElementById("upload-status").innerHTML = "上传成功! 文件名: " + fileName;
                    document.getElementById("audio_url").value = fileUrl;
                    document.getElementById("audio_filename").value = fileName;
                    document.getElementById("submit-button").disabled = false;
                }
            });
            
            document.getElementById("upload_widget").addEventListener("click", function(){
                myWidget.open();
            }, false);
            
            document.getElementById("podcast-form").addEventListener("submit", function(e){
                if (!document.getElementById("audio_url").value) {
                    e.preventDefault();
                    alert("请先上传音频文件!");
                    return false;
                }
            });
        </script>
        
        {% else %}
        <!-- 传统上传模式 -->
        <form method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="title">标题:</label>
                <input type="text" id="title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="description">描述:</label>
                <textarea id="description" name="description" rows="5" required></textarea>
                <small>支持基本HTML标签</small>
            </div>
            
            <div class="form-group">
                <label for="audio_file">音频文件 (MP3):</label>
                <input type="file" id="audio_file" name="audio_file" accept="audio/mp3,audio/mpeg" required>
            </div>
            
            <div class="form-group">
                <label for="password">密码保护 (可选):</label>
                <input type="password" id="password" name="password">
                <small>如果设置密码，此集将不会出现在RSS Feed中</small>
            </div>
            
            <button type="submit" class="rainbow-button">上传播客</button>
        </form>
        {% endif %}
    </div>
{% endblock %}