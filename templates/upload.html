{% extends 'base.html' %}

{% block title %}æ’­å®¢ç®¡ç†{% endblock %}

{% block content %}
    <div class="upload-form">
        <div style="margin: 20px 0; padding: 10px; border: 1px solid #ccc; background: #f9f9f9;">
    <a href="calendar.html" class="btn btn-secondary">ğŸ“… planner</a>
</div>

        <h2>å‘å¸ƒæ–°æ’­å®¢</h2>
        
        {% if use_cloudinary %}
        <!-- Cloudinaryä¸Šä¼ æ¨¡å¼ -->
        <form id="podcast-form" method="post">
            <div class="form-group">
                <label for="title">æ ‡é¢˜:</label>
                <input type="text" id="title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="description">æè¿°:</label>
                <textarea id="description" name="description" rows="5" required></textarea>
                <small>æ”¯æŒåŸºæœ¬HTMLæ ‡ç­¾</small>
            </div>
            
            <div class="form-group">
                <label for="audio_file">éŸ³é¢‘æ–‡ä»¶ (MP3):</label>
                <button type="button" id="upload_widget" class="rainbowplanet-button">é€‰æ‹©éŸ³é¢‘æ–‡ä»¶</button>
                <div id="upload-status"></div>
                <input type="hidden" id="audio_url" name="audio_url">
                <input type="hidden" id="audio_filename" name="audio_filename">
            </div>
            
            <div class="form-group">
                <label for="password">å¯†ç ä¿æŠ¤ (å¯é€‰):</label>
                <input type="password" id="password" name="password">
                <small>å¦‚æœè®¾ç½®å¯†ç ï¼Œæ­¤é›†å°†ä¸ä¼šå‡ºç°åœ¨RSS Feedä¸­</small>
            </div>
            
            <button type="submit" class="rainbowplanet-button" id="submit-button" disabled>ä¸Šä¼ æ’­å®¢</button>
        </form>
        
        <!-- Cloudinaryä¸Šä¼ è„šæœ¬ -->
        <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
        <script>
            const myWidget = cloudinary.createUploadWidget({
                cloudName: "{{ cloud_name }}", // ä½¿ç”¨ä»åç«¯ä¼ é€’çš„cloud_name
                uploadPreset: "{{ upload_preset }}", // ä½¿ç”¨ä»åç«¯ä¼ é€’çš„upload_preset
                resourceType: "auto",
                sources: ["local"],
                multiple: false,
                maxFileSize: 100000000,
                folder: "podcasts",
                allowedFormats: ["mp3", "mpeg"]
            }, (error, result) => {
                if (error) {
                    document.getElementById("upload-status").textContent = "ä¸Šä¼ å‡ºé”™: " + error.message;
                    console.error("Cloudinaryé”™è¯¯:", error);
                    return;
                }
                
                if (result.event === "success") {
                    const fileUrl = result.info.secure_url;
                    const fileName = result.info.original_filename;
                    
                    document.getElementById("upload-status").innerHTML = "ä¸Šä¼ æˆåŠŸ! æ–‡ä»¶å: " + fileName;
                    document.getElementById("audio_url").value = fileUrl;
                    document.getElementById("audio_filename").value = fileName;
                    document.getElementById("submit-button").disabled = false;
                    
                    console.log("ä¸Šä¼ æˆåŠŸ:", result.info);
                } else if (result.event) {
                    console.log("Cloudinaryäº‹ä»¶:", result.event);
                }
            });
            
            document.getElementById("upload_widget").addEventListener("click", function(){
                myWidget.open();
            }, false);
            
            document.getElementById("podcast-form").addEventListener("submit", function(e){
                if (!document.getElementById("audio_url").value) {
                    e.preventDefault();
                    alert("è¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶!");
                    return false;
                }
            });
        </script>
        
        {% else %}
        <!-- ä¼ ç»Ÿä¸Šä¼ æ¨¡å¼ -->
        <form method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="title">æ ‡é¢˜:</label>
                <input type="text" id="title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="description">æè¿°:</label>
                <textarea id="description" name="description" rows="5" required></textarea>
                <small>æ”¯æŒåŸºæœ¬HTMLæ ‡ç­¾</small>
            </div>
            
            <div class="form-group">
                <label for="audio_file">éŸ³é¢‘æ–‡ä»¶ (MP3):</label>
                <input type="file" id="audio_file" name="audio_file" accept="audio/mp3,audio/mpeg" required>
            </div>
            
            <div class="form-group">
                <label for="password">å¯†ç ä¿æŠ¤ (å¯é€‰):</label>
                <input type="password" id="password" name="password">
                <small>å¦‚æœè®¾ç½®å¯†ç ï¼Œæ­¤é›†å°†ä¸ä¼šå‡ºç°åœ¨RSS Feedä¸­</small>
            </div>
            
            <button type="submit" class="rainbowplanet-button">ä¸Šä¼ æ’­å®¢</button>
        </form>
        {% endif %}
    </div>
    
    <!-- æ·»åŠ æ’­å®¢ç®¡ç†åˆ—è¡¨éƒ¨åˆ† -->
    <div class="admin-episodes-list">
        <h2>ç®¡ç†ç°æœ‰æ’­å®¢</h2>
        
        {% if episodes|length > 0 %}
            <div class="episodes-list">
                {% for episode in episodes %}
                <div class="episode-card">
                    <h3>{{ episode.title }}</h3>
                    <div class="episode-meta">
                        <span class="episode-date">{{ episode.pub_date }}</span>
                    </div>
                    <p class="episode-description">{{ episode.description }}</p>
                    <a href="{{ url_for('episode', episode_id=episode.id) }}" class="button">æŸ¥çœ‹æ’­å®¢</a>
                    
                    <!-- åˆ é™¤æŒ‰é’® -->
                    <form action="{{ url_for('delete_episode', episode_id=episode.id) }}" method="post" style="margin-top: 10px;">
                        <button type="submit" class="button" style="background-color: rgba(255, 50, 50, 0.3);"
                            onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ’­å®¢å—ï¼Ÿ');">åˆ é™¤</button>
                    </form>
                    
                    {% if episode.is_demo %}
                    <span style="display: inline-block; margin-top: 8px; font-size: 0.8em; color: #ff5fd7;">* æ¼”ç¤ºæ’­å®¢</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p>è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•æ’­å®¢ã€‚</p>
        {% endif %}
    </div>
{% endblock %}